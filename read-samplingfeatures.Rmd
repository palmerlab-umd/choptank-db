---
title: "How to make a map of the sites in the choptank database"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
password <- scan(".pgpass", what="")
```

```{r, message=FALSE}
library(rgdal) # spatial data types
library(rgeos) # spatial 
library(sf) # spatial
library(uuid) # unique ids
library(RPostgreSQL) # database
library(leaflet)
```

# Connect to the database

To get familiar with the database, see the document on general database interactions

```{r, include=FALSE}
db <- dbConnect(PostgreSQL(), 
                 host = "sesync-postgis01.research.sesync.org",
                 dbname = "choptank", user = "palmergroup",
                 password = password)
```

# Select sites

Query the sampling features table and use the `sf` package to make a spatial object based on the coordinates in the WKT column. 

```{r}
sites <- dbGetQuery(db, "SELECT * FROM odm2.samplingfeatures WHERE samplingfeaturetypecv = 'site'")
sites <- sites[!is.na(sites$featuregeometrywkt),]

sites_sf <- st_as_sf(sites, wkt = "featuregeometrywkt")
```

# Leaflet map

Add sites to simple leaflet map with pop-up of the site name and code. 

```{r}
leaflet(sites_sf) %>%
  addProviderTiles("Esri.WorldImagery") %>%
  addMarkers(popup = ~paste0(samplingfeaturename," (", samplingfeaturecode, ")"))
```

# Save as a kmz

Need to project the coordinates using a coordinate reference system in order to save as a google earth file. Convert to an `sp` object, project the coordinates

```{r}
sites_sp <- as(sites_sf, "Spatial")
proj4string(sites_sp) <- CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")
sites_sp <- spTransform(sites_sp, CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))
```

Add a column called *Name* to show up in google earth

```{r}
sites_sp@data$Name <- paste0(sites_sp@data$samplingfeaturecode, "_", sites_sp@data$samplingfeaturename)
# writeOGR(sites_sp, "sites_5-Oct-2017.kmz", "sites_5-Oct-2017", driver="KML")
```

Don't forget to disconnect at the end

```{r}
dbDisconnect(db)
```

