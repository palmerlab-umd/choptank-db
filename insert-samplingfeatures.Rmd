---
title: "Add new sampling sites from Google Earth file"
output:
  html_document:
    toc: true
    toc_float:
        collapsed: FALSE
editor_options: 
  chunk_output_type: console
---

# Introduction 

__Sites__ are a type of *sampling feature* and are uniquely identified by a unique short code (e.g. a 2-letter code identifying each wetland) as well as a computer-generated universally unique ID (uuid). We can also include a longer name, description, and spatial information. 

The general process comprises:

1. Read in spatial data with site locations
1. Add uuids and rename columns to match database table
1. Convert the spatial information to well-known text (WKT)
1. Append this data frame to the sampling features table in the database

# Set up

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
password <- scan(".pgpass", what="")
```

## Load the necessary libraries

If the library is not installed on your computer, use `install.packages()`. 

```{r, message=FALSE}
library(rgdal) # spatial data types
library(rgeos) # spatial 
library(sf) # spatial
library(uuid) # unique ids
library(RPostgreSQL) # database
library(knitr)
library(DT)
```

## Connect to the database

See [here](https://palmerlab-umd.github.io/choptank-db/connect.html) for details.

```{r, include=FALSE}
db <- dbConnect(PostgreSQL(), 
                 host = "sesync-postgis01.research.sesync.org",
                 dbname = "choptank", user = "palmergroup",
                 password = password)
```

# Read in your data

This example uses a `.kmz` file created from Google Earth. 

```{r}
new_sites <- readOGR(dsn = "sites_6-Nov-2017.kmz")
```

> `new_sites` is a spatial polygons data frame, where the dataframe contains columns called *Name* and *description* from google earth file. 

### Match column names to database fields

Now make data frame to append to sampling features table. Refer to the [ODM2 documentation](http://odm2.github.io/ODM2/schemas/ODM2_Current/tables/ODM2Core_SamplingFeatures.html) for more details on each of the columsn in this table. 

* **code** is the short 2 letter name
* **name** is a longer informative name
* **type** is "site" for sampling locations (compared to specimen for collected samples)
* [FEATURE TYPE CV](http://vocabulary.odm2.org/samplingfeaturetype/)
* for point data: convert geometry to a vector of well-known text (WKT) using `writeWKT()`. More options for spatial information in additional tables in the [sampling features extension](https://github.com/ODM2/ODM2/blob/master/doc/ODM2Docs/ext_samplingfeatures.md)

```{r}
new_samp_features <- data.frame("samplingfeaturecode" = new_sites$Name,
                                "samplingfeaturename" = new_sites$Name,
                                "samplingfeaturetypecv" = "site",
                                "featuregeometrywkt" = writeWKT(new_sites, byid = TRUE),
                                "samplingfeaturegeotypecv" = "point")
```

### Generate uuids

```{r, results='asis'}
new_samp_features$samplingfeatureuuid <- sapply(1:nrow(new_samp_features), UUIDgenerate)

kable(new_samp_features[1:5,])
```


# Append sampling features table

This is the code for updating the table. Running the code within the chunk should update the database. It is not evaluated when the markdown is knit because of the `eval=FALSE` chunk setting, for the purposes of this documentation. 

```{r,eval=FALSE}
dbWriteTable(db, c("odm2","samplingfeatures"),
             new_samp_features,
             overwrite = FALSE,
             row.names = FALSE,
             append = TRUE)
```

# Current sites

```{r, warning=FALSE, message=FALSE}
sites <- dbGetQuery(db, "SELECT * FROM odm2.samplingfeatures WHERE samplingfeaturetypecv = 'site'")
```

```{r, results='asis', echo=FALSE}
datatable(sites)
```

Don't forget to disconnect at the end

```{r}
dbDisconnect(db)
```


