---
title: "Insert soil moisture data"
output:
  html_document:
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

# Getting started

* Format data so each row contains one set of readings from the TDR probe with date, time, sampling location
* Sampling locations need to already be in the database, need to know their name or code
* Date and time will need to be in a standardized format. Use the reference info e.g. [here](http://strftime.org/) to determine what format your date and time info is currently in
* Load the necessary libraries and connect to the database. 

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
password <- scan(".pgpass", what="")
```

```{r, message=FALSE}
library(uuid) # unique ids
library(RPostgreSQL) # database
library(knitr) # kable for table formatting
library(readr) # read_csv
library(DT) # data table formatting
library(lubridate) # dates and times helpers
library(readr)
library(dplyr)
library(magrittr)
```

```{r, include=FALSE}
db <- dbConnect(PostgreSQL(), 
                 host = "sesync-postgis01.research.sesync.org",
                 dbname = "choptank", user = "palmergroup",
                 password = password)
```

# Input data

Read in new data to be inserted into database.

```{r readdata, message=FALSE}
sm <- read_csv("../Delmarva/data/sm/Field_measurements - SOIL_field_measurements.csv")
sm %<>% filter(Date == "March 8, 2018") # filter to subset
head(sm) %>% kable()
```

Make sure that there is a column with the exact sampling feature codes in the database. 

```{r}
sm$samplingfeaturecode <- paste("KLH", paste(sm$Site, sm$Location))
```

# Date and time formatting

Add a column called datetime that has the date formatted as POSIXct, and a column for the UTC offset corresponding to the data to be uploaded. 

```{r}
sm$date <- strptime(sm$Date, format = "%B %d, %Y", tz = "")
sm$datetime <- strptime(paste(sm$Date, sm$Time), format = "%B %d, %Y %H:%M:%S", tz = "")
utcoffset <- format(Sys.time(), "%z")
utcoffset <- as.integer(substr(utcoffset, 1,3))
sm$utcoffset <- -5 # EST
```

# Insert data

Read in the function that constructs the SQL insert statements. See [here](https://github.com/palmerlab-umd/choptank-db/blob/master/insert_soilmoisture_results.R) for details.  

```{r}
source("insert_soilmoisture_results.R")
```

For now, this function requires having a data frame to be called `sm` and columns named:

* samplingfeaturecode
* datetime
* utcoffset
* VWC_percent
* soil_EC_mscm
* soil_temp_C

The actual input to the function is the number row of the `sm` data frame. So to insert the data from the first row, use 

```{r, eval=FALSE}
insert_soilmoisture_results(1)
```

To insert data from the whole `sm` data frame, use an `apply` function. 

```{r insert, eval=FALSE}
lapply(1:nrow(sm), function(x) insert_soilmoisture_results(x))
```

# Query data

If you want to check to make sure its in the database, you can query the database for example: 

```{r}
get_sm_data_site <- function(sitecode = "KLH QB SC B"){
  
  sql <- paste0("SELECT mrv.datavalue, mrv.valuedatetime, sf.samplingfeaturecode, r.featureactionid, v.variablecode, u.unitsname
 FROM odm2.measurementresultvalues mrv, odm2.results r, odm2.variables v, odm2.units u, odm2.samplingfeatures sf, odm2.featureactions fa
 WHERE r.variableid = v.variableid 
 AND r.featureactionid = fa.featureactionid
 AND fa.samplingfeatureid = sf.samplingfeatureid
 AND r.unitsid = u.unitsid
 AND mrv.resultid = r.resultid 
 AND r.sampledmediumcv = 'soil'
 AND sf.samplingfeaturecode = '", sitecode, "'")
  
  sql <- gsub("\n", "", sql)
  dbGetQuery(db, sql)
}

get_sm_data_site(sitecode = "KLH QB SC E") %>% head() %>% kable()
```

Or get all the soil data: 

```{r}
get_sm_data <- function(){
  
  sql <- paste0("SELECT mrv.datavalue, mrv.valuedatetime, sf.samplingfeaturecode, r.featureactionid, v.variablecode, u.unitsname
 FROM odm2.measurementresultvalues mrv, odm2.results r, odm2.variables v, odm2.units u, odm2.samplingfeatures sf, odm2.featureactions fa
 WHERE r.variableid = v.variableid 
 AND r.featureactionid = fa.featureactionid
 AND fa.samplingfeatureid = sf.samplingfeatureid
 AND r.unitsid = u.unitsid
 AND mrv.resultid = r.resultid 
 AND r.sampledmediumcv = 'soil'")

  sql <- gsub("\n", "", sql)
  dbGetQuery(db, sql)
}

sm_db <- get_sm_data()
```

```{r}
DT::datatable(sm_db)
```





