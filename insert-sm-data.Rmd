---
title: "Insert soil moisture data"
output:
  html_document:
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

# Set up

Load the necessary libraries and connect to the database. 

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
password <- scan(".pgpass", what="")
```

If the library is not installed on your computer, use `install.packages()`. 

```{r, message=FALSE}
library(uuid) # unique ids
library(RPostgreSQL) # database
library(knitr) # kable for table formatting
library(readr) # read_csv
library(DT) # data table formatting
library(lubridate) # dates and times helpers
library(readr)
library(dplyr)
library(magrittr)
```

```{r, include=FALSE}
db <- dbConnect(PostgreSQL(), 
                 host = "sesync-postgis01.research.sesync.org",
                 dbname = "choptank", user = "palmergroup",
                 password = password)
```

# Description

Soil moisture data from TDR probe

**Structure of input data**

```{r readdata, message=FALSE}
sm <- read_csv("../Delmarva/data/sm/Field_measurements - SOIL_field_measurements.csv")
head(sm) %>% kable()
```

Make sure that there is a column with the sampling feature codes in the database

```{r}
sm %<>% filter(Date == "March 8, 2018")
sm$samplingfeaturecode <- paste("KLH", paste(sm$Site, sm$Location))
```

# database checks

Make sure all the sites, methods, variables, units are in the database.

```{r}
dbGetQuery(db, "SELECT * FROM odm2.methods") 
dbGetQuery(db, "SELECT * FROM odm2.variables")
dbGetQuery(db, "SELECT * FROM odm2.units WHERE unitsname = 'Percent'")
dbGetQuery(db, "SELECT * FROM odm2.units WHERE unitsname = 'Degree Celcius'")
dbGetQuery(db, "SELECT * FROM odm2.units WHERE unitsabbreviation = 'mS/cm'")
```

# Date formatting

```{r}
sm$date <- strptime(sm$Date, format = "%B %d, %Y", tz = "")
sm$datetime <- strptime(paste(sm$Date, sm$Time), format = "%B %d, %Y %H:%M:%S", tz = "")
utcoffset <- format(Sys.time(), "%z")
utcoffset <- as.integer(substr(utcoffset, 1,3))
sm$utcoffset <- -5 # EST
```

```{r}
source("insert_soilmoisture_results.R")
```


```{r}
lapply(1:nrow(sm), function(x) insert_soilmoisture_results(x))
```

# query data

```{r}
get_sm_data_site <- function(sitecode = "KLH QB SC B"){
  
  sql <- paste0("SELECT mrv.datavalue, mrv.valuedatetime, sf.samplingfeaturecode, r.featureactionid, v.variablecode, u.unitsname
 FROM odm2.measurementresultvalues mrv, odm2.results r, odm2.variables v, odm2.units u, odm2.samplingfeatures sf, odm2.featureactions fa
 WHERE r.variableid = v.variableid 
 AND r.featureactionid = fa.featureactionid
 AND fa.samplingfeatureid = sf.samplingfeatureid
 AND r.unitsid = u.unitsid
 AND mrv.resultid = r.resultid 
 AND r.sampledmediumcv = 'soil'
 AND sf.samplingfeaturecode = '", sitecode, "'")
  
  sql <- gsub("\n", "", sql)
  dbGetQuery(db, sql)
}

get_sm_data_site(sitecode = "KLH QB SC E")
```

```{r}
get_sm_data <- function(){
  
  sql <- paste0("SELECT mrv.datavalue, mrv.valuedatetime, sf.samplingfeaturecode, r.featureactionid, v.variablecode, u.unitsname
 FROM odm2.measurementresultvalues mrv, odm2.results r, odm2.variables v, odm2.units u, odm2.samplingfeatures sf, odm2.featureactions fa
 WHERE r.variableid = v.variableid 
 AND r.featureactionid = fa.featureactionid
 AND fa.samplingfeatureid = sf.samplingfeatureid
 AND r.unitsid = u.unitsid
 AND mrv.resultid = r.resultid 
 AND r.sampledmediumcv = 'soil'")

  sql <- gsub("\n", "", sql)
  dbGetQuery(db, sql)
}

sm_db <- get_sm_data()
```






